name: Update Australian EPG (Foxtel + FTA)

on:
  schedule:
    # Run twice daily at 2:00 AM and 2:00 PM UTC
    - cron: "0 2,14 * * *"
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create public directory
        run: mkdir -p public

      - name: Install XML tools
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet python3-lxml

      - name: Download EPG
        run: |
          echo "Downloading EPG from iptv-epg.org..."
          wget -qO public/epg.xml.gz https://iptv-epg.org/files/epg-au.xml.gz || true
          
          if [ -f public/epg.xml.gz ] && [ -s public/epg.xml.gz ]; then
            gunzip -c public/epg.xml.gz > public/raw_epg.xml
            echo "‚úÖ EPG downloaded and extracted"
          else
            echo "‚ùå Failed to download gz, trying direct xml..."
            wget -qO public/raw_epg.xml https://iptv-epg.org/files/epg-au.xml || true
          fi
          
          # Alternative source if primary fails
          if [ ! -s public/raw_epg.xml ]; then
            echo "Trying alternative source (matthuisman/epg)..."
            wget -qO public/raw_epg.xml https://raw.githubusercontent.com/matthuisman/epg/master/au.xml || true
          fi
          
          if [ ! -s public/raw_epg.xml ]; then
            echo "‚ùå All downloads failed"
            exit 1
          fi
          
          echo "‚úÖ EPG downloaded successfully"
          echo "File size: $(wc -c < public/raw_epg.xml) bytes"

      - name: Filter Australian channels (Foxtel + FTA) and remove prefixes
        run: |
          echo "üîç Starting Australian channel filtering (Foxtel + FTA)..."
          
          # Create a Python script for robust XML processing
          cat > public/filter_epg.py << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          import re
          import sys

          # Parse the XML file (handle namespaces)
          try:
              tree = ET.parse('public/raw_epg.xml')
              root = tree.getroot()
              
              # Handle namespace if present
              namespace = ''
              if root.tag.startswith('{'):
                  namespace = root.tag.split('}')[0] + '}'
                  print(f"Found namespace: {namespace}")
              
              # Define channel tags with namespace
              channel_tag = f"{namespace}channel" if namespace else "channel"
              programme_tag = f"{namespace}programme" if namespace else "programme"
              display_name_tag = f"{namespace}display-name" if namespace else "display-name"
              
              # Define ALL Australian channels to KEEP (Foxtel + FTA)
              keep_patterns = [
                  # Foxtel channels
                  'FOX', 'ESPN', 'SKY NEWS', 'SKY RACING', 'SKY SPORTS',
                  'DISCOVERY', 'LIFESTYLE', 'MOVIE', 'BBC', 'NICK', 
                  'DISNEY', 'COMEDY', 'CRIME', 'DOCOS', 'ARENA',
                  'SPORTS', 'KAYO', 'A&E', 'TLC', 'SYFY', 'PARAMOUNT',
                  'BRAVO', 'MTV', 'CNBC', 'CNN', 'NATIONAL GEOGRAPHIC',
                  'ANIMAL PLANET', 'UKTV', 'BOX', 'MAX', 'STUDIO',
                  'PREMIER', 'RACING', 'OUTDOOR', 'WARNER', 'UNIVERSAL',
                  '13TH', 'E!', 'CARTON', 'CBeebies', 'BOLD',
                  'PEACH', 'SHAKE', 'MATE', 'FLIX', 'GEM', 'GO', 'LIFE',
                  'RUSH', 'HITS', 'ONE', 'SHOWCASE',
                  'CRICKET', 'FOOTY', 'LEAGUE', 'THEATRE', 'ARTS',
                  'ULTRA', 'HD', 'KIDS', 'JR', 'XD', 'PLUS', 'ON DEMAND',
                  
                  # Free-to-Air (FTA) channels
                  'ABC', 'ABC KIDS', 'ABC FAMILY', 'ABC ME', 'ABC NEWS',
                  'SBS', 'SBS VICELAND', 'SBS WORLD MOVIES', 'SBS FOOD',
                  '7', '7TWO', '7MATE', '7FLIX', '7BRAVO',
                  '9', '9GEM', '9GO', '9LIFE', '9RUSH',
                  '10', '10 BOLD', '10 PEACH', '10 SHAKE',
                  'NITV'
              ]
              
              # Function to check if channel should be kept (Australian)
              def should_keep_channel(channel_id, display_text):
                  # Convert to uppercase for comparison
                  channel_id_upper = str(channel_id).upper() if channel_id else ''
                  display_upper = str(display_text).upper() if display_text else ''
                  combined = channel_id_upper + ' ' + display_upper
                  
                  # Check against keep patterns
                  for pattern in keep_patterns:
                      if pattern in combined:
                          return True
                  
                  # Numeric channels (100-999) are likely Foxtel
                  numbers = re.findall(r'\b\d{3}\b', combined)
                  if numbers:
                      return True
                  
                  return False
              
              # Create new root
              new_root = ET.Element(root.tag, root.attrib)
              
              # First pass: collect all Australian channel IDs
              keep_ids = set()
              channels_kept = 0
              
              for channel in root.findall(channel_tag):
                  channel_id = channel.get('id', '')
                  
                  # Get display name text
                  display_name_elem = channel.find(display_name_tag)
                  display_text = display_name_elem.text if display_name_elem is not None else ''
                  
                  if should_keep_channel(channel_id, display_text):
                      # Clone the channel but clean the display name
                      new_channel = ET.Element(channel_tag, channel.attrib)
                      
                      # Copy all subelements but clean display-name
                      for elem in channel:
                          new_elem = ET.SubElement(new_channel, elem.tag, elem.attrib)
                          if elem.text:
                              if elem.tag.endswith('display-name'):
                                  # Clean the display name - remove "AU - " prefix completely
                                  cleaned_text = elem.text
                                  
                                  # Remove "AU - " prefix with all variations
                                  cleaned_text = re.sub(r'^AU\s*-\s*', '', cleaned_text)  # Removes "AU - ", "AU-", "AU -"
                                  cleaned_text = re.sub(r'^AU\s+', '', cleaned_text)      # Removes "AU " (just in case)
                                  
                                  # Also remove any standalone "- " that might remain
                                  cleaned_text = re.sub(r'^-\s+', '', cleaned_text)
                                  
                                  # Trim any remaining whitespace
                                  cleaned_text = cleaned_text.strip()
                                  
                                  new_elem.text = cleaned_text
                              else:
                                  new_elem.text = elem.text
                          else:
                              new_elem.text = elem.text
                      
                      new_root.append(new_channel)
                      keep_ids.add(channel_id)
                      channels_kept += 1
              
              print(f"‚úÖ Kept {channels_kept} Australian channels (Foxtel + FTA)")
              
              # Second pass: add programmes for kept channels
              programmes_kept = 0
              for programme in root.findall(programme_tag):
                  prog_channel = programme.get('channel', '')
                  
                  if prog_channel in keep_ids:
                      new_root.append(programme)
                      programmes_kept += 1
              
              print(f"‚úÖ Kept {programmes_kept} programmes")
              
              # Write the new XML with proper formatting
              from xml.dom import minidom
              rough_string = ET.tostring(new_root, 'utf-8')
              reparsed = minidom.parseString(rough_string)
              
              # Add XML declaration and DOCTYPE
              with open('public/fxtl.xml', 'wb') as f:
                  f.write(b'<?xml version="1.0" encoding="utf-8"?>\n')
                  f.write(b'<!DOCTYPE tv SYSTEM "xmltv.dtd">\n')
                  pretty_xml = reparsed.toprettyxml(indent="  ", encoding='utf-8')
                  # Remove the duplicate XML declaration that minidom adds
                  pretty_xml = pretty_xml.replace(b'<?xml version="1.0" encoding="utf-8"?>\n', b'', 1)
                  f.write(pretty_xml)
              
              print("‚úÖ Filtered EPG written to public/fxtl.xml")
              
          except Exception as e:
              print(f"Error processing XML: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYTHON_SCRIPT

          # Run the Python script
          python3 public/filter_epg.py
          
          # Final cleanup with sed to catch any remaining patterns
          echo "Running final cleanup passes..."
          
          # Remove "AU - " pattern and any variations
          sed -i 's/<display-name>AU - /<display-name>/g' public/fxtl.xml
          sed -i 's/<display-name>AU-/<display-name>/g' public/fxtl.xml
          sed -i 's/<display-name>AU /<display-name>/g' public/fxtl.xml
          sed -i 's/<display-name>- /<display-name>/g' public/fxtl.xml
          sed -i 's/<display-name> - /<display-name>/g' public/fxtl.xml
          sed -i 's/  / /g' public/fxtl.xml
          
          echo "‚úÖ Cleanup complete"

      - name: Generate channel list (channels.md)
        run: |
          echo "# üì∫ Australian Channels (Foxtel + FTA)" > public/channels.md
          echo "" >> public/channels.md
          echo "*This file is automatically updated every time the EPG runs.*" >> public/channels.md
          echo "" >> public/channels.md
          echo "## Channel List" >> public/channels.md
          echo "" >> public/channels.md
          echo "| Channel ID | Clean Display Name |" >> public/channels.md
          echo "|------------|-------------------|" >> public/channels.md
          
          # Extract channels and display names
          while IFS= read -r line; do
              if [[ $line =~ \<channel[[:space:]]+id=\"([^\"]+)\" ]]; then
                  channel_id="${BASH_REMATCH[1]}"
              fi
              if [[ $line =~ \<display-name\>(.*)\</display-name\> ]]; then
                  display_name="${BASH_REMATCH[1]}"
                  echo "| $channel_id | $display_name |" >> public/channels.md
              fi
          done < <(grep -E '<channel|display-name' public/fxtl.xml)
          
          echo "" >> public/channels.md
          
          # Count channel types
          TOTAL_CHANNELS=$(grep -c '<channel' public/fxtl.xml || echo "0")
          FOXTEL_COUNT=$(grep -E '<display-name>.*(FOX|ESPN|SKY|DISCOVERY|LIFESTYLE|MOVIE|BBC|NICK|DISNEY).*' public/fxtl.xml | wc -l)
          FTA_COUNT=$(grep -E '<display-name>.*(ABC|SBS|7|9|10|NITV).*' public/fxtl.xml | wc -l)
          
          echo "## Summary" >> public/channels.md
          echo "" >> public/channels.md
          echo "- **Total channels:** $TOTAL_CHANNELS" >> public/channels.md
          echo "- **Foxtel channels:** ~$FOXTEL_COUNT" >> public/channels.md
          echo "- **Free-to-Air channels:** ~$FTA_COUNT" >> public/channels.md
          echo "" >> public/channels.md
          echo "## EPG File" >> public/channels.md
          echo "" >> public/channels.md
          echo "The EPG XML file is available at:" >> public/channels.md
          echo "```" >> public/channels.md
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/public/fxtl.xml" >> public/channels.md
          echo "```" >> public/channels.md
          echo "" >> public/channels.md
          echo "---" >> public/channels.md
          echo "*Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> public/channels.md
          
          echo "‚úÖ channels.md generated with $TOTAL_CHANNELS channels"

      - name: Validate final EPG
        run: |
          if [ -f public/fxtl.xml ] && [ -s public/fxtl.xml ]; then
              CHANNEL_COUNT=$(grep -c '<channel' public/fxtl.xml || echo "0")
              PROGRAMME_COUNT=$(grep -c '<programme' public/fxtl.xml || echo "0")
              
              echo "‚úÖ EPG Statistics:"
              echo "   - Total Australian channels: $CHANNEL_COUNT"
              echo "   - Total programmes: $PROGRAMME_COUNT"
              echo "   - File size: $(wc -c < public/fxtl.xml) bytes"
              
              # Show sample of FTA channels
              echo ""
              echo "üì∫ Sample Free-to-Air channels:"
              grep -E '<display-name>.*(ABC|SBS|7|9|10).*' public/fxtl.xml | head -5 | sed 's/^[[:space:]]*//' || echo "   None found"
              
              # Show sample of Foxtel channels
              echo ""
              echo "üì∫ Sample Foxtel channels:"
              grep -E '<display-name>.*(FOX|ESPN|SKY|DISCOVERY).*' public/fxtl.xml | head -5 | sed 's/^[[:space:]]*//' || echo "   None found"
              
              # Verify no AU prefixes remain
              AU_COUNT=$(grep -c '<display-name>AU' public/fxtl.xml || echo "0")
              if [ "$AU_COUNT" -gt 0 ]; then
                  echo ""
                  echo "‚ö†Ô∏è Warning: $AU_COUNT channels still have AU prefix"
                  grep '<display-name>AU' public/fxtl.xml | head -3
              else
                  echo ""
                  echo "‚úÖ No AU prefixes found - all display names are clean!"
              fi
          else
              echo "‚ùå EPG file missing or empty"
              exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "EPG Bot"
          git config --global user.email "actions@github.com"
          
          # Add both the XML and the markdown file
          git add public/fxtl.xml public/channels.md
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
              echo "No changes to commit"
          else
              CHANNEL_COUNT=$(grep -c '<channel' public/fxtl.xml || echo "0")
              git commit -m "Update Australian EPG: $(date +'%Y-%m-%d') - ${CHANNEL_COUNT} channels (Foxtel + FTA)"
              git push
              echo "‚úÖ Changes committed and pushed"
              
              # Output the URL for convenience
              echo ""
              echo "üìä EPG updated successfully!"
              echo "   XML: https://raw.githubusercontent.com/${{ github.repository }}/main/public/fxtl.xml"
              echo "   Channel list: https://raw.githubusercontent.com/${{ github.repository }}/main/public/channels.md"
          fi
