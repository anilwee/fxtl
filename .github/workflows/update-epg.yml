name: Update Foxtel EPG

on:
  schedule:
    - cron: "0 2,14 * * *"
  workflow_dispatch:

jobs:
  update-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create public directory
        run: mkdir -p public

      - name: Install XML tools
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet

      - name: Download EPG
        run: |
          # Try multiple sources
          echo "Downloading EPG..."
          
          # Source 1: iptv-epg.org
          if wget -q --spider https://iptv-epg.org/files/epg-au.xml.gz; then
            echo "Downloading from iptv-epg.org..."
            wget -qO public/epg.xml.gz https://iptv-epg.org/files/epg-au.xml.gz
            gunzip -c public/epg.xml.gz > public/raw_epg.xml
            echo "‚úÖ Downloaded from iptv-epg.org"
          
          # Source 2: Alternative iptv-epg.org
          elif wget -q --spider https://iptv-epg.org/files/epg-au.xml; then
            echo "Downloading from iptv-epg.org (xml)..."
            wget -qO public/raw_epg.xml https://iptv-epg.org/files/epg-au.xml
            echo "‚úÖ Downloaded from iptv-epg.org (xml)"
          
          # Source 3: xmlepg.net
          elif wget -q --spider https://www.xmlepg.net/epg.xml; then
            echo "Downloading from xmlepg.net..."
            wget -qO public/raw_epg.xml https://www.xmlepg.net/epg.xml
            echo "‚úÖ Downloaded from xmlepg.net"
          
          # Source 4: GitHub EPG repository
          elif wget -q --spider https://raw.githubusercontent.com/matthuisman/epg/master/au.xml; then
            echo "Downloading from matthuisman/epg..."
            wget -qO public/raw_epg.xml https://raw.githubusercontent.com/matthuisman/epg/master/au.xml
            echo "‚úÖ Downloaded from GitHub EPG"
          
          else
            echo "‚ùå All EPG sources failed"
            # Create a minimal valid EPG file to prevent errors
            echo '<?xml version="1.0" encoding="utf-8"?>
            <!DOCTYPE tv SYSTEM "xmltv.dtd">
            <tv generator-info-name="Fallback">
              <channel id="placeholder">
                <display-name>No EPG Available</display-name>
              </channel>
              <programme channel="placeholder" start="20260213000000" stop="20260214000000">
                <title>EPG Source Unavailable</title>
              </programme>
            </tv>' > public/raw_epg.xml
            echo "‚ö†Ô∏è Created placeholder EPG"
          fi

      - name: Verify EPG file
        run: |
          if [ ! -f public/raw_epg.xml ]; then
            echo "‚ùå No EPG file found"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < public/raw_epg.xml)
          echo "üìÑ EPG file size: $FILE_SIZE bytes"
          
          if [ $FILE_SIZE -lt 1000 ]; then
            echo "‚ö†Ô∏è EPG file is very small ($FILE_SIZE bytes)"
            head -n 20 public/raw_epg.xml
          fi

      - name: Filter Foxtel channels
        run: |
          echo "Filtering Foxtel channels..."
          
          # Check if xmlstarlet can parse the file
          if ! xmlstarlet sel -t -v "name(/*)" public/raw_epg.xml > /dev/null 2>&1; then
            echo "‚ùå Invalid XML file, copying raw file as-is"
            cp public/raw_epg.xml public/fxtl.xml
            exit 0
          fi
          
          # Create a simple filter script using grep/xmlstarlet combo
          # This is more robust than complex XPath queries
          
          # First, get all channel IDs
          xmlstarlet sel -t -v "//channel/@id" public/raw_epg.xml 2>/dev/null | sort -u > public/all_channels.txt
          
          # Define Foxtel channels (simple numeric patterns)
          cat > public/foxtel_patterns.txt << 'EOF'
          101
          102
          103
          104
          105
          106
          107
          108
          109
          110
          111
          112
          113
          114
          115
          130
          131
          132
          133
          134
          135
          150
          151
          152
          153
          154
          155
          201
          202
          203
          204
          205
          206
          301
          302
          303
          304
          305
          306
          307
          308
          501
          502
          503
          504
          505
          506
          601
          602
          603
          604
          EOF
          
          # Filter channels that match Foxtel patterns
          > public/foxtel_channels.txt
          while IFS= read -r channel_id; do
            # Remove AU prefix if present
            clean_id=${channel_id#AU}
            # Check if clean_id matches any pattern
            if grep -q "^$clean_id$" public/foxtel_patterns.txt; then
              echo "$channel_id" >> public/foxtel_channels.txt
            fi
          done < public/all_channels.txt
          
          # If no Foxtel channels found, copy raw file
          if [ ! -s public/foxtel_channels.txt ]; then
            echo "‚ö†Ô∏è No Foxtel channels found, using raw EPG"
            cp public/raw_epg.xml public/fxtl.xml
            exit 0
          fi
          
          echo "‚úÖ Found $(wc -l < public/foxtel_channels.txt) Foxtel channels"
          
          # Build XML with filtered channels using simple approach
          # Extract header
          sed -n '/<channel/,$!p' public/raw_epg.xml > public/header.xml
          
          # Extract only Foxtel channels
          > public/channels.xml
          while IFS= read -r channel_id; do
            xmlstarlet sel -t -c "//channel[@id='$channel_id']" public/raw_epg.xml 2>/dev/null >> public/channels.xml
            echo "" >> public/channels.xml
          done < public/foxtel_channels.txt
          
          # Extract programmes for Foxtel channels
          > public/programmes.xml
          while IFS= read -r channel_id; do
            xmlstarlet sel -t -c "//programme[@channel='$channel_id']" public/raw_epg.xml 2>/dev/null >> public/programmes.xml
            echo "" >> public/programmes.xml
          done < public/foxtel_channels.txt
          
          # Combine everything
          {
            cat public/header.xml
            echo ""
            cat public/channels.xml
            echo ""
            cat public/programmes.xml
            echo "</tv>"
          } > public/fxtl.xml
          
          # Clean up display names (remove AU prefix)
          if command -v xmlstarlet > /dev/null; then
            # Remove AU prefix from display-name
            xmlstarlet ed -N tv="http://www.w3.org/2005/XMLTV" \
              -u "//channel[starts-with(@id, 'AU')]/display-name" \
              -x "substring(., 3)" \
              public/fxtl.xml > public/fxtl_clean.xml
            mv public/fxtl_clean.xml public/fxtl.xml
          fi
          
          echo "‚úÖ EPG processing complete"

      - name: Generate channel list
        run: |
          echo "## üì∫ Foxtel Channels in EPG" > public/channels.md
          echo "" >> public/channels.md
          echo "| Channel ID | Display Name |" >> public/channels.md
          echo "|------------|--------------|" >> public/channels.md
          
          if command -v xmlstarlet > /dev/null && [ -f public/fxtl.xml ]; then
            # Try to extract channel list with xmlstarlet
            xmlstarlet sel -t -m "//channel" \
              -v "concat('| ', @id, ' | ', display-name, ' |')" \
              -n public/fxtl.xml 2>/dev/null >> public/channels.md || \
              echo "| Error | Could not parse channels |" >> public/channels.md
          else
            echo "| No channels | available |" >> public/channels.md
          fi
          
          echo "" >> public/channels.md
          if [ -f public/foxtel_channels.txt ]; then
            echo "Total channels: $(wc -l < public/foxtel_channels.txt)" >> public/channels.md
          fi
          
          cat public/channels.md

      - name: Validate final EPG
        run: |
          if [ -f public/fxtl.xml ] && [ -s public/fxtl.xml ]; then
            FILE_SIZE=$(wc -c < public/fxtl.xml)
            echo "‚úÖ EPG generated: $FILE_SIZE bytes"
            
            # Show first few lines
            echo "First 10 lines of EPG:"
            head -n 10 public/fxtl.xml
          else
            echo "‚ö†Ô∏è EPG file is empty or missing"
            # Create a minimal valid EPG
            echo '<?xml version="1.0" encoding="utf-8"?>
            <!DOCTYPE tv SYSTEM "xmltv.dtd">
            <tv generator-info-name="Foxtel EPG Bot">
              <channel id="foxtel">
                <display-name>Foxtel EPG</display-name>
              </channel>
            </tv>' > public/fxtl.xml
          fi

      - name: Commit and push
        run: |
          git config --global user.name "EPG Bot"
          git config --global user.email "actions@github.com"
          git add public/fxtl.xml public/channels.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            CHANNEL_COUNT=0
            if [ -f public/foxtel_channels.txt ]; then
              CHANNEL_COUNT=$(wc -l < public/foxtel_channels.txt)
            fi
            git commit -m "Update Foxtel EPG: $(date +'%Y-%m-%d') - ${CHANNEL_COUNT} channels"
            git push
            echo "‚úÖ Changes committed and pushed"
          fi
