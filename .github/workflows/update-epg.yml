name: Update Foxtel EPG

on:
  schedule:
    - cron: "0 2,14 * * *"
  workflow_dispatch:

jobs:
  update-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create public directory
        run: mkdir -p public

      - name: Install XML tools
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet

      - name: Download EPG
        run: |
          echo "Downloading EPG from iptv-epg.org..."
          wget -qO public/epg.xml.gz https://iptv-epg.org/files/epg-au.xml.gz || true
          
          if [ -f public/epg.xml.gz ] && [ -s public/epg.xml.gz ]; then
            gunzip -c public/epg.xml.gz > public/raw_epg.xml
            echo "‚úÖ EPG downloaded and extracted"
          else
            echo "‚ùå Failed to download, trying direct xml..."
            wget -qO public/raw_epg.xml https://iptv-epg.org/files/epg-au.xml || true
          fi
          
          if [ ! -s public/raw_epg.xml ]; then
            echo "‚ùå All downloads failed"
            exit 1
          fi
          
          echo "EPG file size: $(wc -c < public/raw_epg.xml) bytes"

      - name: Create definitive Foxtel channel list
        run: |
          # Comprehensive list of actual Foxtel channel IDs
          cat > public/foxtel_channels.txt << 'EOF'
          # Entertainment
          10_BOLD
          10_PEACH
          10_SHAKE
          111
          112
          13TH_STREET
          7MATE
          7TWO
          7FLIX
          9GEM
          9GO
          9LIFE
          9RUSH
          A&E
          ABC
          ABC_KIDS
          ABC_ME
          ANIMAL_PLANET
          ARENA
          BBC_EARTH
          BBC_FIRST
          BBC_UKTV
          BOX_CHANNELS
          BOX_HITS
          BOX_PLUS
          BRAVO
          CARTONETWORK
          CBEBIES
          CBeebies
          CINEMAX
          CNBC
          CNN
          COMEDY
          CRIME
          DISCOVERY
          DISCOVERY_TURBO
          DISCOVERY_SCIENCE
          DISNEY
          DISNEY_JR
          DISNEY_XD
          DOCOS
          E!
          FOX8
          FOX_ARENA
          FOX_COMEDY
          FOX_CRICKET
          FOX_CRIME
          FOX_DOCOS
          FOX_FOOTY
          FOX_HITS
          FOX_LEAGUE
          FOX_MOVIES
          FOX_ONE
          FOX_SHOWCASE
          FOX_SPORTS_500
          FOX_SPORTS_501
          FOX_SPORTS_502
          FOX_SPORTS_503
          FOX_SPORTS_504
          FOX_SPORTS_505
          FOX_SPORTS_506
          FOX_SPORTS_NEWS
          FOX_THEATRE
          FOXTEL_ARTS
          FOXTEL_ARTS
          FOXTEL_MOVIES
          FOXTEL_ON_DEMAND
          FOXTEL_ONE
          FOXTEL_PLUS
          FOXTEL_SPORTS
          FOXTEL_SPORTS_1
          FOXTEL_SPORTS_2
          FOXTEL_SPORTS_3
          FOXTEL_SPORTS_4
          FOXTEL_SPORTS_5
          FOXTEL_SPORTS_6
          FOXTEL_SPORTS_7
          FOXTEL_SPORTS_8
          FOXTEL_SPORTS_9
          FOXTEL_SPORTS_10
          FOXTEL_SPORTS_11
          FOXTEL_ULTRA_HD
          GEM
          GOLD
          HOME
          KAYO_SPORTS_1
          KAYO_SPORTS_2
          KAYO_SPORTS_3
          KAYO_SPORTS_4
          KAYO_SPORTS_5
          KIDS
          LIFESTYLE
          LIFESTYLE_FOOD
          LIFESTYLE_HOME
          MAX
          MOVIE_GREATS
          MOVIE_ONE
          MTV
          MUSIC
          NATIONAL_GEOGRAPHIC
          NICK_JR
          NICKELODEON
          ONE
          OUTDOOR_CHANNEL
          PARAMOUNT
          PPV
          PREMIER_SPORTS
          RACING_COM
          SBS
          SBS_VICELAND
          SBS_WORLD_MOVIES
          SBS_FOOD
          SKY_NEWS
          SKY_NEWS_EXTRA
          SKY_RACING
          SKY_RACING_1
          SKY_RACING_2
          SKY_SPORTS
          SPORTSNET
          STINGRAY
          STUDIO
          SYFY
          TBN
          TLC
          TV1
          TV_HITS
          UKTV
          UNIVERSAL
          WARNER_BROS
          W
          WORLD_MOVIES
          YES
          EOF

      - name: Filter ONLY Foxtel channels and remove AU prefix
        run: |
          echo "üîç Starting aggressive Foxtel-only filtering..."
          
          # Create a Python script for robust XML processing
          cat > public/filter_epg.py << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          import re
          import sys

          # Parse the XML file (handle namespaces)
          try:
              tree = ET.parse('public/raw_epg.xml')
              root = tree.getroot()
              
              # Remove namespace if present for easier processing
              namespace = ''
              if root.tag.startswith('{'):
                  namespace = root.tag.split('}')[0] + '}'
                  print(f"Found namespace: {namespace}")
              
              # Load Foxtel channels
              with open('public/foxtel_channels.txt', 'r') as f:
                  foxtel_channels = [line.strip() for line in f if line.strip() and not line.startswith('#')]
              
              print(f"Loaded {len(foxtel_channels)} Foxtel channel patterns")
              
              # Function to check if channel is Foxtel
              def is_foxtel_channel(channel_id):
                  if not channel_id:
                      return False
                  
                  # Remove AU prefix for checking
                  clean_id = re.sub(r'^AU', '', str(channel_id)).upper()
                  
                  # Direct match
                  if clean_id in foxtel_channels:
                      return True
                  
                  # Partial match (for numeric IDs)
                  for pattern in foxtel_channels:
                      if pattern.isdigit() and clean_id.isdigit() and pattern == clean_id:
                          return True
                      if pattern in clean_id or clean_id in pattern:
                          # Avoid false matches like "FOX" matching "FOX8" is good, but be careful
                          if len(pattern) > 3 and pattern in clean_id:
                              return True
                  
                  # Common Foxtel patterns
                  foxtel_patterns = [
                      'FOX', 'ESPN', 'SKY', 'DISCOVERY', 'LIFESTYLE', 'MOVIE',
                      'BBC', 'NICK', 'DISNEY', 'COMEDY', 'CRIME', 'DOCOS',
                      'ARENA', 'SPORTS', 'KAYO', 'A&E', 'TLC', 'SYFY',
                      'PARAMOUNT', 'BRAVO', 'E!', 'MTV', 'CNBC', 'CNN',
                      'NATIONAL GEOGRAPHIC', 'ANIMAL PLANET'
                  ]
                  
                  for pattern in foxtel_patterns:
                      if pattern in clean_id:
                          return True
                  
                  # Australian FTA channels (NOT Foxtel)
                  fta_channels = ['ABC', 'SBS', '7', '9', '10', 'NITV', 'VICELAND']
                  for fta in fta_channels:
                      if clean_id.startswith(fta) and not any(f in clean_id for f in ['FOX', 'ESPN']):
                          return False
                  
                  # If it has a number and no obvious FTA markers, keep it
                  if re.search(r'\d{3}', clean_id):
                      return True
                  
                  return False
              
              # Create new root with only Foxtel channels
              new_root = ET.Element(root.tag, root.attrib)
              
              # First, collect all Foxtel channel IDs
              foxtel_ids = set()
              
              # Find all channel elements (handle namespace)
              channel_tag = f"{namespace}channel" if namespace else "channel"
              programme_tag = f"{namespace}programme" if namespace else "programme"
              display_name_tag = f"{namespace}display-name" if namespace else "display-name"
              
              print(f"Looking for elements: {channel_tag}")
              
              # Process channels
              channels_kept = 0
              for channel in root.findall(channel_tag):
                  channel_id = channel.get('id', '')
                  
                  if is_foxtel_channel(channel_id):
                      foxtel_ids.add(channel_id)
                      new_root.append(channel)
                      channels_kept += 1
                      
                      # Remove AU prefix from display-name
                      for display_name in channel.findall(display_name_tag):
                          if display_name.text and display_name.text.startswith('AU'):
                              display_name.text = display_name.text[2:]
                  
              print(f"‚úÖ Kept {channels_kept} Foxtel channels")
              
              # Process programmes
              programmes_kept = 0
              for programme in root.findall(programme_tag):
                  prog_channel = programme.get('channel', '')
                  
                  if prog_channel in foxtel_ids:
                      new_root.append(programme)
                      programmes_kept += 1
              
              print(f"‚úÖ Kept {programmes_kept} programmes for Foxtel channels")
              
              # Write the new XML
              new_tree = ET.ElementTree(new_root)
              
              # Properly format the XML
              from xml.dom import minidom
              rough_string = ET.tostring(new_root, 'utf-8')
              reparsed = minidom.parseString(rough_string)
              pretty_xml = reparsed.toprettyxml(indent="  ", encoding='utf-8')
              
              with open('public/fxtl.xml', 'wb') as f:
                  f.write(pretty_xml)
              
              print("‚úÖ Filtered EPG written to public/fxtl.xml")
              
          except Exception as e:
              print(f"Error processing XML: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYTHON_SCRIPT

          # Run the Python script
          python3 public/filter_epg.py
          
          # Verify the result
          if [ -f public/fxtl.xml ]; then
              echo "‚úÖ Final EPG created with $(grep -c '<channel' public/fxtl.xml || echo "0") channels"
              echo "Sample channels:"
              grep -m 5 '<display-name' public/fxtl.xml || echo "No display names found"
          else
              echo "‚ùå Failed to create filtered EPG"
              cp public/raw_epg.xml public/fxtl.xml
          fi

      - name: Generate channel list
        run: |
          echo "# üì∫ Foxtel Channels Only" > public/channels.md
          echo "" >> public/channels.md
          echo "| Channel ID | Display Name |" >> public/channels.md
          echo "|------------|--------------|" >> public/channels.md
          
          # Extract channels using grep (more reliable than xmlstarlet sometimes)
          grep -o '<channel[^>]*>.*?</channel>' public/fxtl.xml | while read -r line; do
              channel_id=$(echo "$line" | grep -o 'id="[^"]*"' | cut -d'"' -f2)
              display_name=$(echo "$line" | grep -o '<display-name>[^<]*' | sed 's/<display-name>//' | head -1)
              if [ -n "$channel_id" ]; then
                  echo "| $channel_id | $display_name |" >> public/channels.md
              fi
          done
          
          echo "" >> public/channels.md
          echo "**Total Foxtel channels: $(grep -c '<channel' public/fxtl.xml)**" >> public/channels.md
          
          echo "Channel list generated:"
          cat public/channels.md

      - name: Validate final EPG
        run: |
          if [ -f public/fxtl.xml ] && [ -s public/fxtl.xml ]; then
              CHANNEL_COUNT=$(grep -c '<channel' public/fxtl.xml || echo "0")
              PROGRAMME_COUNT=$(grep -c '<programme' public/fxtl.xml || echo "0")
              
              echo "‚úÖ EPG Statistics:"
              echo "   - Foxtel channels: $CHANNEL_COUNT"
              echo "   - Programmes: $PROGRAMME_COUNT"
              echo "   - File size: $(wc -c < public/fxtl.xml) bytes"
              
              # Check if AU prefix is gone
              if grep -q '<display-name>AU' public/fxtl.xml; then
                  echo "‚ö†Ô∏è Warning: Some AU prefixes remain"
              else
                  echo "‚úÖ No AU prefixes found in display names"
              fi
          else
              echo "‚ùå EPG file missing or empty"
              exit 1
          fi

      - name: Commit and push
        run: |
          git config --global user.name "EPG Bot"
          git config --global user.email "actions@github.com"
          git add public/fxtl.xml public/channels.md
          
          if git diff --staged --quiet; then
              echo "No changes to commit"
          else
              CHANNEL_COUNT=$(grep -c '<channel' public/fxtl.xml || echo "0")
              git commit -m "Update Foxtel EPG: $(date +'%Y-%m-%d') - ${CHANNEL_COUNT} Foxtel channels, AU prefix removed"
              git push
              echo "‚úÖ Changes committed"
          fi
