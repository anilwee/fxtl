name: Update Foxtel EPG

on:
  schedule:
    - cron: "0 2,14 * * *"
  workflow_dispatch:

jobs:
  update-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create public directory
        run: mkdir -p public

      - name: Install XML tools
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet python3-lxml

      - name: Download EPG
        run: |
          echo "Downloading EPG from iptv-epg.org..."
          wget -qO public/epg.xml.gz https://iptv-epg.org/files/epg-au.xml.gz || true
          
          if [ -f public/epg.xml.gz ] && [ -s public/epg.xml.gz ]; then
            gunzip -c public/epg.xml.gz > public/raw_epg.xml
            echo "‚úÖ EPG downloaded and extracted"
          else
            echo "‚ùå Failed to download, trying direct xml..."
            wget -qO public/raw_epg.xml https://iptv-epg.org/files/epg-au.xml || true
          fi
          
          if [ ! -s public/raw_epg.xml ]; then
            echo "‚ùå All downloads failed"
            exit 1
          fi
          
          echo "EPG file size: $(wc -c < public/raw_epg.xml) bytes"

      - name: Filter ONLY Foxtel channels and remove "AU - " prefix
        run: |
          echo "üîç Starting aggressive Foxtel-only filtering..."
          
          # Create a Python script for robust XML processing
          cat > public/filter_epg.py << 'PYTHON_SCRIPT'
          import xml.etree.ElementTree as ET
          import re
          import sys

          # Parse the XML file (handle namespaces)
          try:
              tree = ET.parse('public/raw_epg.xml')
              root = tree.getroot()
              
              # Handle namespace if present
              namespace = ''
              if root.tag.startswith('{'):
                  namespace = root.tag.split('}')[0] + '}'
                  print(f"Found namespace: {namespace}")
              
              # Define channel tags with namespace
              channel_tag = f"{namespace}channel" if namespace else "channel"
              programme_tag = f"{namespace}programme" if namespace else "programme"
              display_name_tag = f"{namespace}display-name" if namespace else "display-name"
              
              # Define Foxtel channel patterns (what to KEEP)
              foxtel_patterns = [
                  'FOX', 'ESPN', 'SKY NEWS', 'SKY RACING', 'SKY SPORTS',
                  'DISCOVERY', 'LIFESTYLE', 'MOVIE', 'BBC', 'NICK', 
                  'DISNEY', 'COMEDY', 'CRIME', 'DOCOS', 'ARENA',
                  'SPORTS', 'KAYO', 'A&E', 'TLC', 'SYFY', 'PARAMOUNT',
                  'BRAVO', 'MTV', 'CNBC', 'CNN', 'NATIONAL GEOGRAPHIC',
                  'ANIMAL PLANET', 'UKTV', 'BOX', 'MAX', 'STUDIO',
                  'PREMIER', 'RACING', 'OUTDOOR', 'WARNER', 'UNIVERSAL',
                  '13TH', 'E!', 'SYFY', 'CARTON', 'CBeebies', 'BOLD',
                  'PEACH', 'SHAKE', 'MATE', 'FLIX', 'GEM', 'GO', 'LIFE',
                  'RUSH', '111', '112', 'HITS', 'ONE', 'SHOWCASE',
                  'CRICKET', 'FOOTY', 'LEAGUE', 'THEATRE', 'ARTS',
                  'ULTRA', 'HD', 'KIDS', 'JR', 'XD', 'PLUS', 'ON DEMAND'
              ]
              
              # Australian FTA channels to REMOVE (explicitly filter these out)
              fta_channels = [
                  'ABC', 'SBS', '7', '9', '10', 'NITV', 'VICELAND',
                  '7TWO', '7MATE', '7FLIX', '9GEM', '9GO', '9LIFE',
                  '10 BOLD', '10 PEACH', '10 SHAKE'
              ]
              
              # Function to check if channel is Foxtel (NOT FTA)
              def is_foxtel_channel(channel_id, display_text):
                  # Convert to uppercase for comparison
                  channel_id_upper = str(channel_id).upper() if channel_id else ''
                  display_upper = str(display_text).upper() if display_text else ''
                  combined = channel_id_upper + ' ' + display_upper
                  
                  # First check: If it contains any FTA pattern, reject it
                  for fta in fta_channels:
                      if fta in combined:
                          # But make sure it's not part of a Foxtel channel
                          # e.g., "FOX CRICKET" should not be rejected because of "CRICKET"
                          if 'FOX' not in combined and 'ESPN' not in combined:
                              return False
                  
                  # Second check: Must match at least one Foxtel pattern
                  for pattern in foxtel_patterns:
                      if pattern in combined:
                          return True
                  
                  # Third check: Numeric channels (100-999) are likely Foxtel
                  numbers = re.findall(r'\b\d{3}\b', combined)
                  if numbers:
                      return True
                  
                  return False
              
              # Create new root
              new_root = ET.Element(root.tag, root.attrib)
              
              # First pass: collect all Foxtel channel IDs
              foxtel_ids = set()
              channels_kept = 0
              
              for channel in root.findall(channel_tag):
                  channel_id = channel.get('id', '')
                  
                  # Get display name text
                  display_name_elem = channel.find(display_name_tag)
                  display_text = display_name_elem.text if display_name_elem is not None else ''
                  
                  if is_foxtel_channel(channel_id, display_text):
                      # Clone the channel but clean the display name
                      new_channel = ET.Element(channel_tag, channel.attrib)
                      
                      # Copy all subelements but clean display-name
                      for elem in channel:
                          new_elem = ET.SubElement(new_channel, elem.tag, elem.attrib)
                          if elem.text:
                              if elem.tag.endswith('display-name'):
                                  # Clean the display name - remove "AU - " and just "AU " prefixes
                                  cleaned_text = elem.text
                                  # Remove patterns like "AU - ", "AU-", "AU " at the beginning
                                  cleaned_text = re.sub(r'^AU\s*-\s*', '', cleaned_text)  # Removes "AU - "
                                  cleaned_text = re.sub(r'^AU\s+', '', cleaned_text)      # Removes "AU " 
                                  cleaned_text = re.sub(r'^AU-', '', cleaned_text)        # Removes "AU-"
                                  new_elem.text = cleaned_text
                                  print(f"Cleaned: '{elem.text}' -> '{cleaned_text}'")
                              else:
                                  new_elem.text = elem.text
                          else:
                              new_elem.text = elem.text
                      
                      new_root.append(new_channel)
                      foxtel_ids.add(channel_id)
                      channels_kept += 1
              
              print(f"‚úÖ Kept {channels_kept} Foxtel channels")
              
              # Second pass: add programmes for kept channels
              programmes_kept = 0
              for programme in root.findall(programme_tag):
                  prog_channel = programme.get('channel', '')
                  
                  if prog_channel in foxtel_ids:
                      new_root.append(programme)
                      programmes_kept += 1
              
              print(f"‚úÖ Kept {programmes_kept} programmes")
              
              # Write the new XML with proper formatting
              from xml.dom import minidom
              rough_string = ET.tostring(new_root, 'utf-8')
              reparsed = minidom.parseString(rough_string)
              
              # Add XML declaration and DOCTYPE
              with open('public/fxtl.xml', 'wb') as f:
                  f.write(b'<?xml version="1.0" encoding="utf-8"?>\n')
                  f.write(b'<!DOCTYPE tv SYSTEM "xmltv.dtd">\n')
                  pretty_xml = reparsed.toprettyxml(indent="  ", encoding='utf-8')
                  # Remove the duplicate XML declaration that minidom adds
                  pretty_xml = pretty_xml.replace(b'<?xml version="1.0" encoding="utf-8"?>\n', b'', 1)
                  f.write(pretty_xml)
              
              print("‚úÖ Filtered EPG written to public/fxtl.xml")
              
              # Verification
              print("\n=== SAMPLE CLEANED CHANNELS ===")
              with open('public/fxtl.xml', 'r') as f:
                  lines = f.readlines()
                  sample_count = 0
                  for line in lines:
                      if '<display-name>' in line and sample_count < 10:
                          print(line.strip())
                          sample_count += 1
              
          except Exception as e:
              print(f"Error processing XML: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYTHON_SCRIPT

          # Run the Python script
          python3 public/filter_epg.py
          
          # Verify no "AU - " prefixes remain
          if grep -q '<display-name>AU' public/fxtl.xml; then
              echo "‚ö†Ô∏è Warning: Some AU prefixes still remain. Applying final cleanup..."
              # Final pass with sed to catch any remaining
              sed -i 's/<display-name>AU - /<display-name>/g' public/fxtl.xml
              sed -i 's/<display-name>AU /<display-name>/g' public/fxtl.xml
              sed -i 's/<display-name>AU-/<display-name>/g' public/fxtl.xml
          fi

      - name: Generate channel list
        run: |
          echo "# üì∫ Foxtel Channels Only" > public/channels.md
          echo "" >> public/channels.md
          echo "| Channel ID | Clean Display Name |" >> public/channels.md
          echo "|------------|-------------------|" >> public/channels.md
          
          # Extract channels and display names
          while IFS= read -r line; do
              if [[ $line =~ \<channel[[:space:]]+id=\"([^\"]+)\" ]]; then
                  channel_id="${BASH_REMATCH[1]}"
              fi
              if [[ $line =~ \<display-name\>(.*)\</display-name\> ]]; then
                  display_name="${BASH_REMATCH[1]}"
                  echo "| $channel_id | $display_name |" >> public/channels.md
              fi
          done < <(grep -E '<channel|display-name' public/fxtl.xml)
          
          echo "" >> public/channels.md
          echo "**Total Foxtel channels: $(grep -c '<channel' public/fxtl.xml)**" >> public/channels.md
          echo "" >> public/channels.md
          echo "‚úÖ All 'AU - ' prefixes have been removed from display names." >> public/channels.md
          
          echo "Channel list generated:"
          cat public/channels.md

      - name: Validate final EPG
        run: |
          if [ -f public/fxtl.xml ] && [ -s public/fxtl.xml ]; then
              CHANNEL_COUNT=$(grep -c '<channel' public/fxtl.xml || echo "0")
              PROGRAMME_COUNT=$(grep -c '<programme' public/fxtl.xml || echo "0")
              
              echo "‚úÖ EPG Statistics:"
              echo "   - Foxtel channels: $CHANNEL_COUNT"
              echo "   - Programmes: $PROGRAMME_COUNT"
              echo "   - File size: $(wc -c < public/fxtl.xml) bytes"
              
              # Check if any AU prefixes remain
              AU_COUNT=$(grep -c '<display-name>AU' public/fxtl.xml || echo "0")
              if [ "$AU_COUNT" -gt 0 ]; then
                  echo "‚ö†Ô∏è Warning: $AU_COUNT channels still have AU prefix"
                  grep '<display-name>AU' public/fxtl.xml | head -5
              else
                  echo "‚úÖ No AU prefixes found - all clean!"
              fi
              
              # Show sample of clean channel names
              echo ""
              echo "Sample of clean channel names:"
              grep '<display-name>' public/fxtl.xml | head -10 | sed 's/^[[:space:]]*//'
          else
              echo "‚ùå EPG file missing or empty"
              exit 1
          fi

      - name: Commit and push
        run: |
          git config --global user.name "EPG Bot"
          git config --global user.email "actions@github.com"
          git add public/fxtl.xml public/channels.md
          
          if git diff --staged --quiet; then
              echo "No changes to commit"
          else
              CHANNEL_COUNT=$(grep -c '<channel' public/fxtl.xml || echo "0")
              git commit -m "Update Foxtel EPG: $(date +'%Y-%m-%d') - ${CHANNEL_COUNT} channels, AU prefixes removed"
              git push
              echo "‚úÖ Changes committed"
          fi
